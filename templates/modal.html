<!-- Modal Create/Update -->
<div id="crudModal" class="hidden fixed inset-0 z-50 w-full flex items-center justify-center bg-gray-800/50">
  <div id="crudModalContent" class="bg-white rounded-lg shadow-lg w-[92%] max-w-2xl max-h-screen overflow-y-auto">
    <!-- header -->
    <div class="flex items-center justify-between p-4 border-b">
      <div>
        <h3 id="crudTitle" class="text-xl font-semibold text-gray-900">Create Product</h3>
        <p id="crudSubtitle" class="text-sm text-gray-600 mt-1">Fill the form below</p>
      </div>
      <button type="button" class="text-gray-400 hover:text-gray-900 p-1.5" onclick="hideModal()">âœ•</button>
    </div>
    <!-- body -->
    <div class="px-6 py-4">
      <form id="productForm" class="space-y-4">
        <input type="hidden" id="currentId" name="currentId" value="">
        <div class="grid sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium">Name</label>
            <input id="name" name="name" type="text" class="mt-1 w-full border rounded-md px-3 py-2" required>
          </div>
          <div>
            <label class="block text-sm font-medium">Price</label>
            <input id="price" name="price" type="number" class="mt-1 w-full border rounded-md px-3 py-2" required>
          </div>
          <div class="sm:col-span-2">
            <label class="block text-sm font-medium">Description</label>
            <textarea id="description" name="description" rows="3" class="mt-1 w-full border rounded-md px-3 py-2" required></textarea>
          </div>
          <div class="sm:col-span-2">
            <label class="block text-sm font-medium">Thumbnail URL</label>
            <input id="thumbnail" name="thumbnail" type="url" class="mt-1 w-full border rounded-md px-3 py-2">
          </div>
          <div>
            <label class="block text-sm font-medium">Category</label>
            <select id="category" name="category" class="mt-1 w-full border rounded-md px-3 py-2" required>
              <option value="home">Home Jersey</option>
              <option value="away">Away Jersey</option>
              <option value="third">Third Jersey</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium">Condition</label>
            <select id="condition" name="condition" class="mt-1 w-full border rounded-md px-3 py-2">
              <option value="mint">Mint</option>
              <option value="second">Second</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium">Club Name</label>
            <input id="club_name" name="club_name" type="text" class="mt-1 w-full border rounded-md px-3 py-2">
          </div>
          <div>
            <label class="block text-sm font-medium">Season</label>
            <input id="season" name="season" type="text" class="mt-1 w-full border rounded-md px-3 py-2" placeholder="e.g. 1998/1999">
          </div>
          <div>
            <label class="block text-sm font-medium">Release Year</label>
            <input id="release_year" name="release_year" type="number" class="mt-1 w-full border rounded-md px-3 py-2">
          </div>
          <div class="flex items-center gap-2">
            <input id="is_featured" name="is_featured" type="checkbox" class="w-4 h-4">
            <label for="is_featured" class="text-sm font-medium">Featured</label>
          </div>
          <div class="flex items-center gap-2">
            <input id="authenticity" name="authenticity" type="checkbox" class="w-4 h-4" checked>
            <label for="authenticity" class="text-sm font-medium">Authentic</label>
          </div>
        </div>
      </form>
    </div>
    <!-- footer -->
    <div class="flex flex-col sm:flex-row gap-3 p-6 border-t">
      <button type="button" class="order-2 sm:order-1 px-5 py-2 border rounded-md" onclick="hideModal()">Cancel</button>
      <button type="submit" form="productForm" id="submitProduct" class="order-1 sm:order-2 px-5 py-2 rounded-md bg-gray-900 text-white">Save</button>
    </div>
  </div>
</div>

<!-- Modal Confirm Delete -->
<div id="confirmModal" class="hidden fixed inset-0 z-50 w-full flex items-center justify-center bg-gray-800/50">
  <div class="bg-white rounded-lg shadow-lg w-[92%] max-w-md">
    <div class="p-5 border-b">
      <h3 class="text-lg font-semibold">Delete Product</h3>
      <p class="text-sm text-gray-600 mt-1">Are you sure you want to delete this product?</p>
    </div>
    <div class="p-5 flex gap-3 justify-end">
      <button class="px-4 py-2 border rounded-md" onclick="hideConfirm()">Cancel</button>
      <button id="confirmDeleteBtn" class="px-4 py-2 rounded-md bg-red-600 text-white">Delete</button>
    </div>
  </div>
</div>

<script>
  // ---- Modal Show/Hide ----
  function showModal(mode='create', product=null) {
    const modal = document.getElementById('crudModal');
    const content = document.getElementById('crudModalContent');
    document.getElementById('crudTitle').textContent = mode === 'edit' ? 'Edit Product' : 'Create Product';
    document.getElementById('crudSubtitle').textContent = mode === 'edit' ? 'Update product details' : 'Fill the form below';

    // reset form
    document.getElementById('productForm').reset();
    document.getElementById('currentId').value = '';

    if (mode === 'edit' && product) {
      document.getElementById('currentId').value = product.id;
      document.getElementById('name').value = product.name || '';
      document.getElementById('price').value = product.price ?? '';
      document.getElementById('description').value = product.description || '';
      document.getElementById('thumbnail').value = product.thumbnail || '';
      document.getElementById('category').value = product.category || 'home';
      document.getElementById('condition').value = product.condition || 'mint';
      document.getElementById('club_name').value = product.club_name || '';
      document.getElementById('season').value = product.season || '';
      document.getElementById('release_year').value = product.release_year ?? '';
      document.getElementById('is_featured').checked = !!product.is_featured;
      document.getElementById('authenticity').checked = !!product.authenticity;
    }

    modal.classList.remove('hidden');
    setTimeout(()=> {
      content.classList.remove('opacity-0','scale-95');
      content.classList.add('opacity-100','scale-100');
    }, 10);
  }
  function hideModal() {
    const modal = document.getElementById('crudModal');
    const content = document.getElementById('crudModalContent');
    content.classList.remove('opacity-100','scale-100');
    content.classList.add('opacity-0','scale-95');
    setTimeout(()=> modal.classList.add('hidden'), 150);
  }

  let __deleteId = null;
  function showConfirmDelete(id) {
    __deleteId = id;
    document.getElementById('confirmModal').classList.remove('hidden');
  }
  function hideConfirm() {
    __deleteId = null;
    document.getElementById('confirmModal').classList.add('hidden');
  }

  // ---- Submit Create/Update via AJAX ----
  document.getElementById('productForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const id = document.getElementById('currentId').value;
    const url = id 
      ? `{% url 'main:update_product_ajax' 0 %}`.replace('/0/', `/${id}/`)
      : `{% url 'main:add_product_ajax' %}`;

    const formData = new FormData(this);

    try {
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'X-Requested-With':'XMLHttpRequest',
          'X-CSRFToken': window.CSRF_TOKEN,
          'Accept': 'application/json'
        },
        body: formData
      });
      const data = await res.json();
      if (!res.ok || !data.success) {
        const msg = data.message || 'Validation error';
        showToast('Failed', msg, 'error');
        return;
      }
      hideModal();
      showToast(id ? 'Product updated' : 'Product created', '', 'success');
      document.dispatchEvent(new CustomEvent('productsChanged'));
    } catch (err) {
      showToast('Network Error', 'Please try again', 'error');
    }
  });

  // ---- Perform Delete via AJAX ----
  document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
    if (!__deleteId) return;
    const url = `{% url 'main:delete_product_ajax' 0 %}`.replace('/0/', `/${__deleteId}/`);
    try {
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'X-Requested-With':'XMLHttpRequest',
          'X-CSRFToken': window.CSRF_TOKEN,
          'Accept': 'application/json'
        }
      });
      const data = await res.json();
      if (!res.ok || !data.success) {
        showToast('Delete failed', 'Please try again.', 'error');
        return;
      }
      hideConfirm();
      showToast('Product deleted', '', 'success');
      document.dispatchEvent(new CustomEvent('productsChanged'));
    } catch {
      showToast('Network Error', 'Please try again.', 'error');
    }
  });
</script>
